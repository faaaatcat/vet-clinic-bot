–õ–∏—Å—Ç–∏–Ω–≥ –ø—Ä–æ–µ–∫—Ç–∞: .
–°–æ–∑–¥–∞–Ω: 2025-11-21 23:32:25
==================================================


============================================================
–§–ê–ô–õ: bot.py
============================================================

import asyncio
import logging
from aiogram import Bot, Dispatcher
from aiogram.client.default import DefaultBotProperties
from aiogram.enums import ParseMode
from aiogram.fsm.storage.memory import MemoryStorage

from config import BOT_TOKEN
from db.db_init import init_db

# –†–æ—É—Ç–µ—Ä—ã
from handlers import registration, pets, booking, common, notifications, appointments, calendar

# === –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ ===
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s [%(levelname)s] %(message)s"
)

# === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö ===
init_db()
logging.info("‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞.")

# === –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–æ—Ç–∞ –∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞ ===
bot = Bot(
    token=BOT_TOKEN,
    default=DefaultBotProperties(parse_mode=ParseMode.HTML)
)
storage = MemoryStorage()
dp = Dispatcher(storage=storage)

# === –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–æ—É—Ç–µ—Ä–æ–≤ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ ===
# –í–∞–∂–Ω—ã–π –º–æ–º–µ–Ω—Ç: booking –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –¥–æ common, —á—Ç–æ–±—ã '–ú–æ–∏ –∑–∞–ø–∏—Å–∏' –Ω–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–ª–∏—Å—å
dp.include_router(registration.router)
dp.include_router(pets.router)
dp.include_router(booking.router)
dp.include_router(common.router)
dp.include_router(notifications.router)
dp.include_router(appointments.router)


async def main():
    logging.info("üöÄ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω")

    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–æ–Ω–æ–≤—É—é –∑–∞–¥–∞—á—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    asyncio.create_task(notifications.check_and_send_notifications(bot))

    try:
        await dp.start_polling(bot)
    finally:
        await bot.session.close()
        logging.info("üõë –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")


if __name__ == "__main__":
    asyncio.run(main())


============================================================
–§–ê–ô–õ: combine_code.py
============================================================

import os
from datetime import datetime

def create_code_listing(project_path, output_file, extensions=['.py', '.txt', '.md']):
    with open(output_file, 'w', encoding='utf-8') as outfile:
        outfile.write(f"–õ–∏—Å—Ç–∏–Ω–≥ –ø—Ä–æ–µ–∫—Ç–∞: {os.path.basename(project_path)}\n")
        outfile.write(f"–°–æ–∑–¥–∞–Ω: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
        outfile.write("="*50 + "\n\n")
        
        for root, dirs, files in os.walk(project_path):
            # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ –ø–∞–ø–∫–∏
            dirs[:] = [d for d in dirs if not d.startswith('.') and d not in ['__pycache__', 'venv']]
            
            for file in files:
                if any(file.endswith(ext) for ext in extensions):
                    file_path = os.path.join(root, file)
                    relative_path = os.path.relpath(file_path, project_path)
                    
                    outfile.write(f"\n{'='*60}\n")
                    outfile.write(f"–§–ê–ô–õ: {relative_path}\n")
                    outfile.write(f"{'='*60}\n\n")
                    
                    try:
                        with open(file_path, 'r', encoding='utf-8') as infile:
                            content = infile.read()
                            outfile.write(content)
                            outfile.write("\n")
                    except Exception as e:
                        outfile.write(f"–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: {e}\n")

if __name__ == "__main__":
    project_path = "."  # –¢–µ–∫—É—â–∞—è –ø–∞–ø–∫–∞
    output_file = "project_listing.txt"
    create_code_listing(project_path, output_file)
    print(f"–õ–∏—Å—Ç–∏–Ω–≥ —Å–æ–∑–¥–∞–Ω: {output_file}")


============================================================
–§–ê–ô–õ: config.py
============================================================

import os
from dotenv import load_dotenv

load_dotenv()

BOT_TOKEN = os.getenv("BOT_TOKEN")

if not BOT_TOKEN:
    raise ValueError("‚ùå BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env! –î–æ–±–∞–≤—å –µ–≥–æ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º.")


============================================================
–§–ê–ô–õ: project_listing.txt
============================================================



============================================================
–§–ê–ô–õ: requirements.txt
============================================================

aiogram==3.12.0
apscheduler==3.10.4
python-dotenv==1.0.1
aiogram3-calendar



============================================================
–§–ê–ô–õ: db\db_init.py
============================================================

# db/db_init.py
import sqlite3
from pathlib import Path
from datetime import date, timedelta
from db.db_utils import generate_schedule_for_all_doctors

DB_PATH = Path("db/vet_clinic.db")

def init_db():
    DB_PATH.parent.mkdir(parents=True, exist_ok=True)
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()

    # === –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü ===
    cur.executescript("""
    CREATE TABLE IF NOT EXISTS users (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        telegram_id INTEGER UNIQUE NOT NULL,
        phone TEXT,
        full_name TEXT,
        reg_date TEXT DEFAULT CURRENT_TIMESTAMP
    );

    CREATE TABLE IF NOT EXISTS pets (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER NOT NULL,
        name TEXT NOT NULL,
        species TEXT,
        age TEXT,
        FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
    );

    CREATE TABLE IF NOT EXISTS doctors (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        full_name TEXT NOT NULL,
        specialty TEXT
    );

    CREATE TABLE IF NOT EXISTS services (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT NOT NULL,
        duration INTEGER NOT NULL,
        price REAL
    );

    -- –°–≤—è–∑—å: –∫–∞–∫–∏–µ —É—Å–ª—É–≥–∏ –¥–µ–ª–∞–µ—Ç –∫–∞–∫–æ–π –≤—Ä–∞—á
    CREATE TABLE IF NOT EXISTS doctor_services (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        doctor_id INTEGER NOT NULL,
        service_id INTEGER NOT NULL,
        FOREIGN KEY (doctor_id) REFERENCES doctors(id) ON DELETE CASCADE,
        FOREIGN KEY (service_id) REFERENCES services(id) ON DELETE CASCADE,
        UNIQUE (doctor_id, service_id)
    );

    -- –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ: —Å–ª–æ—Ç—ã (–æ–¥–∏–Ω —Å–ª–æ—Ç = –æ–¥–∏–Ω —á–∞—Å)
    CREATE TABLE IF NOT EXISTS schedule (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        doctor_id INTEGER NOT NULL,
        date TEXT NOT NULL,   -- ISO: YYYY-MM-DD
        time TEXT NOT NULL,   -- HH:MM (start time)
        is_booked INTEGER DEFAULT 0,
        UNIQUE (doctor_id, date, time),
        FOREIGN KEY (doctor_id) REFERENCES doctors(id) ON DELETE CASCADE
    );

    -- –ó–∞–ø–∏—Å–∏: –ø—Ä–∏–≤—è–∑–∫–∞ –∫ schedule
    CREATE TABLE IF NOT EXISTS appointments (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER NOT NULL,
        pet_id INTEGER NOT NULL,
        doctor_id INTEGER NOT NULL,
        service_id INTEGER NOT NULL,
        schedule_id INTEGER NOT NULL,
        status TEXT DEFAULT 'scheduled',
        created_at TEXT DEFAULT CURRENT_TIMESTAMP, notified_24h INTEGER DEFAULT 0, notified_2h INTEGER DEFAULT 0, 
        FOREIGN KEY (user_id) REFERENCES users(id),
        FOREIGN KEY (pet_id) REFERENCES pets(id),
        FOREIGN KEY (doctor_id) REFERENCES doctors(id),
        FOREIGN KEY (service_id) REFERENCES services(id),
        FOREIGN KEY (schedule_id) REFERENCES schedule(id)
    );
    """)

    conn.commit()
    conn.close()

    # –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ 14 –¥–Ω–µ–π –≤–ø–µ—Ä—ë–¥
    generate_schedule_for_all_doctors()
    print("‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ.")


============================================================
–§–ê–ô–õ: db\db_utils.py
============================================================

# db/db_utils.py:
import sqlite3
from pathlib import Path
from datetime import date, timedelta

DB_PATH = Path("db/vet_clinic.db")


def connect():
    """–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö."""
    return sqlite3.connect(DB_PATH)


# =========================
# Doctors / Services
# =========================
def get_doctors():
    with connect() as conn:
        cur = conn.cursor()
        cur.execute("SELECT id, full_name, specialty FROM doctors ORDER BY full_name")
        return cur.fetchall()


def add_doctor(full_name, specialty):
    with connect() as conn:
        cur = conn.cursor()
        cur.execute("INSERT INTO doctors (full_name, specialty) VALUES (?, ?)", (full_name, specialty))
        conn.commit()
        return cur.lastrowid


def get_services():
    with connect() as conn:
        cur = conn.cursor()
        cur.execute("SELECT id, name, duration, price FROM services ORDER BY name")
        return cur.fetchall()


def add_service(name, duration, price):
    with connect() as conn:
        cur = conn.cursor()
        cur.execute("INSERT INTO services (name, duration, price) VALUES (?, ?, ?)", (name, duration, price))
        conn.commit()
        return cur.lastrowid


# =========================
# Users / Pets
# =========================
def get_user_by_telegram_id(tg_id):
    with connect() as conn:
        cur = conn.cursor()
        cur.execute("SELECT id, telegram_id, phone, full_name FROM users WHERE telegram_id=?", (tg_id,))
        return cur.fetchone()


def get_user_by_phone(phone):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞."""
    with connect() as conn:
        cur = conn.cursor()
        cur.execute("SELECT id, telegram_id, phone, full_name FROM users WHERE phone=?", (phone,))
        return cur.fetchone()


def add_user(telegram_id, phone=None, full_name=None):
    with connect() as conn:
        cur = conn.cursor()
        cur.execute(
            "INSERT OR IGNORE INTO users (telegram_id, phone, full_name) VALUES (?, ?, ?)",
            (telegram_id, phone, full_name)
        )
        conn.commit()
        cur.execute("SELECT id FROM users WHERE telegram_id=?", (telegram_id,))
        return cur.fetchone()[0]


def add_pet(user_id, name, species=None, age=None):
    with connect() as conn:
        cur = conn.cursor()
        cur.execute("INSERT INTO pets (user_id, name, species, age) VALUES (?, ?, ?, ?)",
                    (user_id, name, species, age))
        conn.commit()
        return cur.lastrowid


def get_user_pets(user_id):
    with connect() as conn:
        cur = conn.cursor()
        cur.execute("SELECT id, name, species, age FROM pets WHERE user_id=? ORDER BY id", (user_id,))
        return cur.fetchall()


# =========================
# Schedule & Booking
# =========================
def generate_schedule_for_all_doctors(days_ahead=14, work_start=9, work_end=19):
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ª–æ—Ç—ã –¥–ª—è –≤—Å–µ—Ö –≤—Ä–∞—á–µ–π –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ `days_ahead` –¥–Ω–µ–π.
    –í—Ä–∞—á–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –ø–Ω-–ø—Ç, —Å–ª–æ—Ç—ã –∫–∞–∂–¥—ã–π —á–∞—Å: –æ—Ç work_start –¥–æ work_end-1.
    """
    today = date.today()
    end_date = today + timedelta(days=days_ahead)
    with connect() as conn:
        cur = conn.cursor()
        cur.execute("SELECT id FROM doctors")
        doctors = [r[0] for r in cur.fetchall()]
        for doctor_id in doctors:
            current = today
            while current <= end_date:
                if current.weekday() < 5:  # –ø–Ω-–ø—Ç
                    iso = current.isoformat()
                    for h in range(work_start, work_end):
                        time_str = f"{h:02d}:00"
                        try:
                            cur.execute(
                                "INSERT OR IGNORE INTO schedule (doctor_id, date, time, is_booked) VALUES (?, ?, ?, 0)",
                                (doctor_id, iso, time_str)
                            )
                        except sqlite3.IntegrityError:
                            pass
                current += timedelta(days=1)
        conn.commit()


def cleanup_old_schedule(keep_days=14):
    """–£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ —Å–ª–æ—Ç—ã –∏ –æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –±–ª–∏–∂–∞–π—à–∏–µ `keep_days` –¥–Ω–µ–π."""
    today = date.today()
    cutoff = today - timedelta(days=1)
    with connect() as conn:
        cur = conn.cursor()
        cur.execute("DELETE FROM schedule WHERE date < ?", (cutoff.isoformat(),))
        conn.commit()


def get_available_dates_for_doctor(doctor_id, limit_days=14, limit_dates=14):
    today = date.today()
    end_date = today + timedelta(days=limit_days)
    with connect() as conn:
        cur = conn.cursor()
        cur.execute("""
            SELECT DISTINCT date
            FROM schedule
            WHERE doctor_id=? AND is_booked=0 AND date BETWEEN ? AND ?
            ORDER BY date
            LIMIT ?
        """, (doctor_id, today.isoformat(), end_date.isoformat(), limit_dates))
        return [r[0] for r in cur.fetchall()]


def get_available_slots_for_doctor_on_date(doctor_id, date_iso):
    with connect() as conn:
        cur = conn.cursor()
        cur.execute("""
            SELECT id, time
            FROM schedule
            WHERE doctor_id=? AND date=? AND is_booked=0
            ORDER BY time
        """, (doctor_id, date_iso))
        return cur.fetchall()


def book_slot(schedule_id, user_id, pet_id, service_id):
    """–ë—Ä–æ–Ω–∏—Ä—É–µ—Ç —Å–ª–æ—Ç –∏ —Å–æ–∑–¥–∞—ë—Ç –∑–∞–ø–∏—Å—å –≤ appointments."""
    with connect() as conn:
        cur = conn.cursor()
        cur.execute("SELECT doctor_id, date, time, is_booked FROM schedule WHERE id=?", (schedule_id,))
        row = cur.fetchone()
        if not row:
            raise ValueError("–°–ª–æ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω")
        doctor_id, date_iso, time_str, is_booked = row
        if is_booked:
            raise ValueError("–°–ª–æ—Ç —É–∂–µ –∑–∞–Ω—è—Ç")

        # –ø–æ–º–µ—á–∞–µ–º —Å–ª–æ—Ç –∫–∞–∫ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π
        cur.execute("UPDATE schedule SET is_booked=1 WHERE id=?", (schedule_id,))

        # —Å–æ–∑–¥–∞—ë–º appointment
        cur.execute("""
            INSERT INTO appointments (user_id, pet_id, doctor_id, service_id, schedule_id, status)
            VALUES (?, ?, ?, ?, ?, 'scheduled')
        """, (user_id, pet_id, doctor_id, service_id, schedule_id))
        appointment_id = cur.lastrowid
        conn.commit()
        return appointment_id


def get_user_appointments(user_id):
    with connect() as conn:
        cur = conn.cursor()
        cur.execute("""
            SELECT a.id, s.name, d.full_name, sch.date, sch.time, a.status, p.name
            FROM appointments a
            JOIN services s ON a.service_id = s.id
            JOIN doctors d ON a.doctor_id = d.id
            JOIN schedule sch ON a.schedule_id = sch.id
            JOIN pets p ON a.pet_id = p.id
            WHERE a.user_id = ?
            ORDER BY sch.date, sch.time
        """, (user_id,))
        return cur.fetchall()


def cancel_appointment(appointment_id: int, free_slot: bool = False) -> bool:
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    try:
        # –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º schedule_id —ç—Ç–æ–π –∑–∞–ø–∏—Å–∏
        cur.execute("SELECT schedule_id FROM appointments WHERE id = ?", (appointment_id,))
        result = cur.fetchone()
        if not result:
            return False
        schedule_id = result[0]

        # –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å
        cur.execute("DELETE FROM appointments WHERE id = ?", (appointment_id,))

        # –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º —Å–ª–æ—Ç, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if free_slot:
            cur.execute("UPDATE schedule SET is_booked = 0 WHERE id = ?", (schedule_id,))

        conn.commit()
        return True
    except Exception as e:
        print("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–ø–∏—Å–∏:", e)
        return False
    finally:
        conn.close()


def get_doctors_by_service(service_id):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Ä–∞—á–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –¥–µ–ª–∞—é—Ç –≤—ã–±—Ä–∞–Ω–Ω—É—é —É—Å–ª—É–≥—É"""
    with connect() as conn:
        cur = conn.cursor()
        cur.execute("""
            SELECT DISTINCT d.id, d.full_name, d.specialty
            FROM doctors d
            JOIN doctor_services ds ON d.id = ds.doctor_id
            WHERE ds.service_id = ?
            ORDER BY d.full_name
        """, (service_id,))
        return cur.fetchall()

============================================================
–§–ê–ô–õ: db\__init__.py
============================================================



============================================================
–§–ê–ô–õ: handlers\appointments.py
============================================================

from aiogram import Router, F
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, CallbackQuery
from datetime import date
from db.db_utils import get_user_by_telegram_id, get_user_appointments, cancel_appointment
from handlers.common import main_menu_inline

router = Router()


# --- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è —Å–ø–∏—Å–∫–∞ –∑–∞–ø–∏—Å–µ–π ---
def appointments_kb(appointments):
    buttons = []
    for a in appointments:
        appointment_id = a[0]
        buttons.append([InlineKeyboardButton(text=f"‚ùå –û—Ç–º–µ–Ω–∏—Ç—å: {a[6]} ({a[3]} {a[4]})", callback_data=f"cancel_appointment_{appointment_id}")])
    buttons.append([InlineKeyboardButton(text="üè† –í –º–µ–Ω—é", callback_data="back_to_menu")])
    return InlineKeyboardMarkup(inline_keyboard=buttons)


# --- –ü–æ–∫–∞–∑–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏ ---
@router.callback_query(F.data == "my_appointments")
async def show_my_appointments(callback: CallbackQuery):
    user = get_user_by_telegram_id(callback.from_user.id)
    if not user:
        await callback.message.answer("‚ùó –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã. –í–≤–µ–¥–∏—Ç–µ /start.")
        await callback.answer()
        return

    appointments = get_user_appointments(user[0])
    today_iso = date.today().isoformat()

    # –§–∏–ª—å—Ç—Ä—É–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ (—Å–µ–≥–æ–¥–Ω—è –∏ –±—É–¥—É—â–∏–µ)
    upcoming = [a for a in appointments if a[3] >= today_iso]

    if not upcoming:
        await callback.message.edit_text(
            "üìÖ –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π.",
            reply_markup=main_menu_inline()
        )
        await callback.answer()
        return

    # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –∑–∞–ø–∏—Å–∏ –≤ –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
    text_parts = []
    for a in upcoming:
        appointment_id, service_name, doctor_name, appt_date, appt_time, status, pet_name = a
        text_parts.append(
            f"üêæ <b>{pet_name}</b>\n"
            f"üë©‚Äç‚öïÔ∏è <b>{doctor_name}</b>\n"
            f"üßæ {service_name}\n"
            f"üìÖ {appt_date} ‚Äî {appt_time}\n"
            f"üìå –°—Ç–∞—Ç—É—Å: <i>{status}</i>\n"
            "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
        )

    text = "üìã <b>–í–∞—à–∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏:</b>\n\n" + "\n\n".join(text_parts)

    await callback.message.edit_text(
        text,
        reply_markup=appointments_kb(upcoming),
        parse_mode="HTML"
    )

    await callback.answer()


# --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω—ã –∑–∞–ø–∏—Å–∏ ---
@router.callback_query(F.data.startswith("cancel_appointment_"))
async def cancel_appointment_handler(callback: CallbackQuery):
    appointment_id = int(callback.data.split("_")[-1])

    # –ü–æ–ø—ã—Ç–∫–∞ —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –∏ –æ—Å–≤–æ–±–æ–¥–∏—Ç—å —Å–ª–æ—Ç
    success = cancel_appointment(appointment_id, free_slot=True)

    if success:
        await callback.answer("‚úÖ –ó–∞–ø–∏—Å—å –æ—Ç–º–µ–Ω–µ–Ω–∞!", show_alert=False)

        # –ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π
        user = get_user_by_telegram_id(callback.from_user.id)
        appointments = get_user_appointments(user[0])
        today_iso = date.today().isoformat()
        upcoming = [a for a in appointments if a[3] >= today_iso]

        if upcoming:
            text_parts = []
            for a in upcoming:
                appointment_id, service_name, doctor_name, appt_date, appt_time, status, pet_name = a
                text_parts.append(
                    f"üêæ <b>{pet_name}</b>\n"
                    f"üë©‚Äç‚öïÔ∏è <b>{doctor_name}</b>\n"
                    f"üßæ {service_name}\n"
                    f"üìÖ {appt_date} ‚Äî {appt_time}\n"
                    f"üìå –°—Ç–∞—Ç—É—Å: <i>{status}</i>\n"
                    "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
                )
            text = "üìã <b>–í–∞—à–∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏:</b>\n\n" + "\n\n".join(text_parts)
            await callback.message.edit_text(text, reply_markup=appointments_kb(upcoming), parse_mode="HTML")
        else:
            await callback.message.edit_text("üìÖ –£ –≤–∞—Å –±–æ–ª—å—à–µ –Ω–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π.", reply_markup=main_menu_inline())

    else:
        await callback.answer("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å.", show_alert=True)


============================================================
–§–ê–ô–õ: handlers\booking.py
============================================================

# handlers/booking.py
from aiogram import Router, F
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, CallbackQuery
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup

from db.db_utils import (
    get_user_by_telegram_id,
    get_services,
    get_doctors_by_service,
    get_available_dates_for_doctor,
    get_available_slots_for_doctor_on_date,
    get_user_pets,
    book_slot
)
from handlers.common import main_menu_inline
from handlers.calendar import SimpleCalendar, SimpleCalendarCallback

router = Router()


# === FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è ===
class BookingStates(StatesGroup):
    service = State()
    doctor = State()
    date = State()
    time = State()
    pet = State()


# === –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Å—Ç—Ä–æ–∏—Ç–µ–ª–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä ===
def build_list_kb(items, footer_rows=None):
    """
    items: list of tuples (text, callback_data) -> –∫–∞–∂–¥–∞—è –≤ —Å–≤–æ–µ–π —Å—Ç—Ä–æ–∫–µ
    footer_rows: list of rows, where each row is list of tuples (text, callback)
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç InlineKeyboardMarkup
    """
    kb_rows = []
    for txt, cb in items:
        kb_rows.append([InlineKeyboardButton(text=txt, callback_data=cb)])
    if footer_rows:
        for row in footer_rows:
            kb_rows.append([InlineKeyboardButton(text=t, callback_data=c) for (t, c) in row])
    return InlineKeyboardMarkup(inline_keyboard=kb_rows)


def nav_footer(back_cb: str = None):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç footer rows –¥–ª—è build_list_kb"""
    footer = []
    if back_cb:
        footer.append(("üîô –ù–∞–∑–∞–¥", back_cb))
    footer.append(("üè† –í –º–µ–Ω—é", "back_to_menu"))
    return [footer]


# === –°—Ç–∞—Ä—Ç –∑–∞–ø–∏—Å–∏: –≤—ã–±–∏—Ä–∞–µ–º —É—Å–ª—É–≥—É ===
@router.callback_query(F.data == "book_visit")
async def start_booking(callback: CallbackQuery, state: FSMContext):
    await callback.answer()
    user = get_user_by_telegram_id(callback.from_user.id)
    if not user:
        await callback.message.answer("‚ùó –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã. –í–≤–µ–¥–∏—Ç–µ /start, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å.")
        return

    services = get_services()
    if not services:
        await callback.message.answer("‚ö†Ô∏è –ü–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—Å–ª—É–≥.")
        return

    items = [(f"{s[1]} ‚Äî {s[3]}‚ÇΩ", f"choose_service_{s[0]}") for s in services]
    kb = build_list_kb(items, footer_rows=nav_footer())

    try:
        await callback.message.edit_text("üßæ –í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É:", reply_markup=kb)
    except Exception:
        await callback.message.answer("üßæ –í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É:", reply_markup=kb)

    await state.set_state(BookingStates.service)


# === –í—ã–±–æ—Ä —É—Å–ª—É–≥–∏ -> —Å–ø–∏—Å–æ–∫ –≤—Ä–∞—á–µ–π (—Ñ–∏–ª—å—Ç—Ä –ø–æ —É—Å–ª—É–≥–µ) ===
@router.callback_query(BookingStates.service, F.data.startswith("choose_service_"))
async def choose_service(callback: CallbackQuery, state: FSMContext):
    await callback.answer()
    try:
        service_id = int(callback.data.split("_")[-1])
    except Exception:
        await callback.message.answer("‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—ã–±–æ—Ä–∞ —É—Å–ª—É–≥–∏.")
        return

    await state.update_data(service_id=service_id)

    doctors = get_doctors_by_service(service_id)
    if not doctors:
        try:
            await callback.message.edit_text("‚ö†Ô∏è –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–µ—Ç –≤—Ä–∞—á–µ–π, –≤—ã–ø–æ–ª–Ω—è—é—â–∏—Ö —ç—Ç—É —É—Å–ª—É–≥—É.")
        except Exception:
            await callback.message.answer("‚ö†Ô∏è –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–µ—Ç –≤—Ä–∞—á–µ–π, –≤—ã–ø–æ–ª–Ω—è—é—â–∏—Ö —ç—Ç—É —É—Å–ª—É–≥—É.")
        return

    items = [(f"{d[1]} ({d[2] or '—Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å'})", f"choose_doctor_{d[0]}") for d in doctors]
    kb = build_list_kb(items, footer_rows=nav_footer("back_to_service"))

    try:
        await callback.message.edit_text("üë©‚Äç‚öïÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–∞—á–∞ (–æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –ø–æ —É—Å–ª—É–≥–µ):", reply_markup=kb)
    except Exception:
        await callback.message.answer("üë©‚Äç‚öïÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–∞—á–∞ (–æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –ø–æ —É—Å–ª—É–≥–µ):", reply_markup=kb)

    await state.set_state(BookingStates.doctor)


# === –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É —É—Å–ª—É–≥–∏ ===
@router.callback_query(BookingStates.doctor, F.data == "back_to_service")
async def back_to_service(callback: CallbackQuery, state: FSMContext):
    await callback.answer()
    services = get_services()
    items = [(f"{s[1]} ‚Äî {s[3]}‚ÇΩ", f"choose_service_{s[0]}") for s in services]
    kb = build_list_kb(items, footer_rows=nav_footer())
    try:
        await callback.message.edit_text("üßæ –í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É:", reply_markup=kb)
    except Exception:
        await callback.message.answer("üßæ –í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É:", reply_markup=kb)
    await state.set_state(BookingStates.service)


# === –í—ã–±–æ—Ä –≤—Ä–∞—á–∞ -> –¥–∞—Ç—ã ===
@router.callback_query(BookingStates.doctor, F.data.startswith("choose_doctor_"))
async def choose_doctor(callback: CallbackQuery, state: FSMContext):
    await callback.answer()
    try:
        doctor_id = int(callback.data.split("_")[-1])
    except Exception:
        await callback.message.answer("‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—ã–±–æ—Ä–∞ –≤—Ä–∞—á–∞.")
        return

    await state.update_data(doctor_id=doctor_id)

    dates = get_available_dates_for_doctor(doctor_id)
    if not dates:
        try:
            await callback.message.edit_text("‚ö†Ô∏è –£ —ç—Ç–æ–≥–æ –≤—Ä–∞—á–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∞—Ç –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ 2 –Ω–µ–¥–µ–ª–∏.")
        except Exception:
            await callback.message.answer("‚ö†Ô∏è –£ —ç—Ç–æ–≥–æ –≤—Ä–∞—á–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∞—Ç –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ 2 –Ω–µ–¥–µ–ª–∏.")
        return

    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å
    calendar_markup = await SimpleCalendar().start_calendar(
        available_dates=dates,
        days_ahead=14
    )

    try:
        await callback.message.edit_text(
            "üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –ø—Ä–∏—ë–º–∞:\n\n"
            "üìç - —Å–µ–≥–æ–¥–Ω—è | üå¥ - –≤—ã—Ö–æ–¥–Ω–æ–π\n"
            "–¢–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã",
            reply_markup=calendar_markup
        )
    except Exception:
        await callback.message.answer(
            "üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –ø—Ä–∏—ë–º–∞:\n\n"
            "üìç - —Å–µ–≥–æ–¥–Ω—è | üå¥ - –≤—ã—Ö–æ–¥–Ω–æ–π\n"
            "–¢–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã",
            reply_markup=calendar_markup
        )

    await state.set_state(BookingStates.date)


# === –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã –∏–∑ –∫–∞–ª–µ–Ω–¥–∞—Ä—è ===
@router.callback_query(BookingStates.date, SimpleCalendarCallback.filter())
async def process_calendar_selection(callback: CallbackQuery, callback_data: SimpleCalendarCallback, state: FSMContext):
    success, selected_date = await SimpleCalendar.process_selection(callback, callback_data)

    if success and selected_date:
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª –¥–∞—Ç—É
        date_iso = selected_date.isoformat()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–Ω–∞ –ª–∏ —ç—Ç–∞ –¥–∞—Ç–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤—Ä–∞—á–∞
        data = await state.get_data()
        doctor_id = data.get("doctor_id")

        if not doctor_id:
            await callback.message.answer("‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–∞—á–∞.")
            return

        available_dates = get_available_dates_for_doctor(doctor_id)
        if date_iso not in available_dates:
            await callback.answer("‚ùå –≠—Ç–∞ –¥–∞—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏", show_alert=True)
            return

        # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –∫–∞–∫ –≤ choose_date
        await state.update_data(date=date_iso)
        slots = get_available_slots_for_doctor_on_date(doctor_id, date_iso)

        if not slots:
            try:
                await callback.message.edit_text("‚è≥ –ù–∞ —ç—Ç—É –¥–∞—Ç—É –Ω–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤. –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥—É—é –¥–∞—Ç—É.")
            except Exception:
                await callback.message.answer("‚è≥ –ù–∞ —ç—Ç—É –¥–∞—Ç—É –Ω–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤. –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥—É—é –¥–∞—Ç—É.")
            return

        # –°–æ–∑–¥–∞–µ–º —Å–µ—Ç–∫—É –∫–Ω–æ–ø–æ–∫ –≤—Ä–µ–º–µ–Ω–∏
        kb_rows = []
        row = []
        for s in slots:
            sched_id, time_str = s
            row.append(InlineKeyboardButton(text=time_str, callback_data=f"choose_time_{sched_id}"))
            if len(row) == 3:
                kb_rows.append(row)
                row = []
        if row:
            kb_rows.append(row)

        # –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        kb_rows.append([InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥ –∫ –¥–∞—Ç–∞–º", callback_data="back_to_calendar")])
        kb_rows.append([InlineKeyboardButton(text="üè† –í –º–µ–Ω—é", callback_data="back_to_menu")])
        kb = InlineKeyboardMarkup(inline_keyboard=kb_rows)

        try:
            await callback.message.edit_text(f"üïì –°–≤–æ–±–æ–¥–Ω—ã–µ —Å–ª–æ—Ç—ã –Ω–∞ {date_iso}:", reply_markup=kb)
        except Exception:
            await callback.message.answer(f"üïì –°–≤–æ–±–æ–¥–Ω—ã–µ —Å–ª–æ—Ç—ã –Ω–∞ {date_iso}:", reply_markup=kb)

        await state.set_state(BookingStates.time)

    elif success and selected_date is None:
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª –≤—ã–±–æ—Ä –¥–∞—Ç—ã
        await callback.message.edit_text("‚ùå –í—ã–±–æ—Ä –¥–∞—Ç—ã –æ—Ç–º–µ–Ω–µ–Ω.", reply_markup=main_menu_inline())
        await state.clear()


# === –ù–∞–∑–∞–¥ –∫ –∫–∞–ª–µ–Ω–¥–∞—Ä—é ===
@router.callback_query(BookingStates.time, F.data == "back_to_calendar")
async def back_to_calendar(callback: CallbackQuery, state: FSMContext):
    await callback.answer()
    data = await state.get_data()
    doctor_id = data.get("doctor_id")
    if not doctor_id:
        await callback.message.answer("‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–∞—á–∞.")
        return

    dates = get_available_dates_for_doctor(doctor_id)
    calendar_markup = await SimpleCalendar().start_calendar(
        available_dates=dates,
        days_ahead=14
    )

    try:
        await callback.message.edit_text(
            "üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –ø—Ä–∏—ë–º–∞:\n\n"
            "üìç - —Å–µ–≥–æ–¥–Ω—è | üå¥ - –≤—ã—Ö–æ–¥–Ω–æ–π\n"
            "–¢–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã",
            reply_markup=calendar_markup
        )
    except Exception:
        await callback.message.answer(
            "üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –ø—Ä–∏—ë–º–∞:\n\n"
            "üìç - —Å–µ–≥–æ–¥–Ω—è | üå¥ - –≤—ã—Ö–æ–¥–Ω–æ–π\n"
            "–¢–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã",
            reply_markup=calendar_markup
        )

    await state.set_state(BookingStates.date)


# === –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É –≤—Ä–∞—á–∞ ===
@router.callback_query(BookingStates.date, F.data == "back_to_doctor")
async def back_to_doctor(callback: CallbackQuery, state: FSMContext):
    await callback.answer()
    data = await state.get_data()
    service_id = data.get("service_id")
    if not service_id:
        # –µ—Å–ª–∏ –Ω–µ—Ç —Å–µ—Ä–≤–∏—Å–∞ –≤ –ø–∞–º—è—Ç–∏ ‚Äî –ø—Ä–æ—Å—Ç–æ –≤–µ—Ä–Ω—ë–º—Å—è –≤ –º–µ–Ω—é —É—Å–ª—É–≥
        services = get_services()
        items = [(f"{s[1]} ‚Äî {s[3]}‚ÇΩ", f"choose_service_{s[0]}") for s in services]
        kb = build_list_kb(items, footer_rows=nav_footer())
        try:
            await callback.message.edit_text("üßæ –í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É:", reply_markup=kb)
        except Exception:
            await callback.message.answer("üßæ –í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É:", reply_markup=kb)
        await state.set_state(BookingStates.service)
        return

    doctors = get_doctors_by_service(service_id)
    items = [(f"{d[1]} ({d[2] or '—Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å'})", f"choose_doctor_{d[0]}") for d in doctors]
    kb = build_list_kb(items, footer_rows=nav_footer("back_to_service"))
    try:
        await callback.message.edit_text("üë©‚Äç‚öïÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–∞—á–∞:", reply_markup=kb)
    except Exception:
        await callback.message.answer("üë©‚Äç‚öïÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–∞—á–∞:", reply_markup=kb)
    await state.set_state(BookingStates.doctor)


# === –í—ã–±–æ—Ä –≤—Ä–µ–º–µ–Ω–∏ -> –≤—ã–±–æ—Ä –ø–∏—Ç–æ–º—Ü–∞ ===
@router.callback_query(BookingStates.time, F.data.startswith("choose_time_"))
async def choose_time(callback: CallbackQuery, state: FSMContext):
    await callback.answer()
    try:
        schedule_id = int(callback.data.split("_")[-1])
    except Exception:
        await callback.message.answer("‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏.")
        return

    await state.update_data(schedule_id=schedule_id)

    user = get_user_by_telegram_id(callback.from_user.id)
    if not user:
        await callback.message.answer("‚ùó –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –í–≤–µ–¥–∏—Ç–µ /start.")
        return

    pets = get_user_pets(user[0])

    if not pets:
        # –ø—Ä–µ–¥–ª–æ–∂–∏–º –ø–µ—Ä–µ–π—Ç–∏ –≤ —Ä–∞–∑–¥–µ–ª "–ú–æ–∏ –ø–∏—Ç–æ–º—Ü—ã" (—á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å)
        kb = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–∏—Ç–æ–º—Ü–∞", callback_data="add_pet")],
            [InlineKeyboardButton(text="üè† –í –º–µ–Ω—é", callback_data="back_to_menu")]
        ])
        try:
            await callback.message.edit_text(
                "üêæ –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø–∏—Ç–æ–º—Ü–µ–≤. –ß—Ç–æ–±—ã –∑–∞–ø–∏—Å–∞—Ç—å—Å—è ‚Äî —Å–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –ø–∏—Ç–æ–º—Ü–∞.",
                reply_markup=kb
            )
        except Exception:
            await callback.message.answer(
                "üêæ –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø–∏—Ç–æ–º—Ü–µ–≤. –ß—Ç–æ–±—ã –∑–∞–ø–∏—Å–∞—Ç—å—Å—è ‚Äî —Å–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –ø–∏—Ç–æ–º—Ü–∞.",
                reply_markup=kb
            )
        await state.set_state(BookingStates.pet)
        return

    items = [(p[1], f"choose_pet_{p[0]}") for p in pets]
    kb = build_list_kb(items, footer_rows=nav_footer("back_to_time"))

    try:
        await callback.message.edit_text("üê∂ –í—ã–±–µ—Ä–∏—Ç–µ –ø–∏—Ç–æ–º—Ü–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏:", reply_markup=kb)
    except Exception:
        await callback.message.answer("üê∂ –í—ã–±–µ—Ä–∏—Ç–µ –ø–∏—Ç–æ–º—Ü–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏:", reply_markup=kb)

    await state.set_state(BookingStates.pet)


# === –ù–∞–∑–∞–¥ –∫–æ –≤—Ä–µ–º–µ–Ω–∏ ===
@router.callback_query(BookingStates.pet, F.data == "back_to_time")
async def back_to_time(callback: CallbackQuery, state: FSMContext):
    await callback.answer()
    data = await state.get_data()
    doctor_id = data.get("doctor_id")
    date_iso = data.get("date")
    if not (doctor_id and date_iso):
        await callback.message.answer("‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–∞—á–∞ –∏ –¥–∞—Ç—É.")
        return

    slots = get_available_slots_for_doctor_on_date(doctor_id, date_iso)
    # —Å—Ç—Ä–æ–∏–º —Å–µ—Ç–∫—É –∫–∞–∫ –≤ choose_date
    if not slots:
        await callback.message.edit_text("‚è≥ –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É.")
        return

    kb_rows = []
    row = []
    for s in slots:
        sched_id, time_str = s
        row.append(InlineKeyboardButton(text=time_str, callback_data=f"choose_time_{sched_id}"))
        if len(row) == 3:
            kb_rows.append(row)
            row = []
    if row:
        kb_rows.append(row)
    kb_rows.append([InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥ –∫ –¥–∞—Ç–∞–º", callback_data="back_to_calendar")])
    kb_rows.append([InlineKeyboardButton(text="üè† –í –º–µ–Ω—é", callback_data="back_to_menu")])
    kb = InlineKeyboardMarkup(inline_keyboard=kb_rows)

    try:
        await callback.message.edit_text("üïì –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è:", reply_markup=kb)
    except Exception:
        await callback.message.answer("üïì –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è:", reply_markup=kb)

    await state.set_state(BookingStates.time)


# === –í—ã–±–æ—Ä –ø–∏—Ç–æ–º—Ü–∞ -> —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø–∏—Å–∏ ===
@router.callback_query(BookingStates.pet, F.data.startswith("choose_pet_"))
async def choose_pet(callback: CallbackQuery, state: FSMContext):
    await callback.answer()
    try:
        pet_id = int(callback.data.split("_")[-1])
    except Exception:
        await callback.message.answer("‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—ã–±–æ—Ä–∞ –ø–∏—Ç–æ–º—Ü–∞.")
        return

    await state.update_data(pet_id=pet_id)
    data = await state.get_data()

    schedule_id = data.get("schedule_id")
    user = get_user_by_telegram_id(callback.from_user.id)
    service_id = data.get("service_id")
    date_iso = data.get("date")

    if not (schedule_id and user and service_id and date_iso):
        await callback.message.answer("‚ùå –û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—á–Ω–∏—Ç–µ –∑–∞–ø–∏—Å—å –∑–∞–Ω–æ–≤–æ.")
        await state.clear()
        return

    try:
        appointment_id = book_slot(schedule_id, user[0], pet_id, service_id)
    except ValueError as e:
        await callback.message.answer(f"‚ö†Ô∏è –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ—Ç: {e}")
        await state.clear()
        return

    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    from db.db_utils import connect
    with connect() as conn:
        cur = conn.cursor()
        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–∏—Ç–æ–º—Ü–µ
        cur.execute("SELECT name FROM pets WHERE id = ?", (pet_id,))
        pet_name = cur.fetchone()[0]

        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É—Å–ª—É–≥–µ
        cur.execute("SELECT name FROM services WHERE id = ?", (service_id,))
        service_name = cur.fetchone()[0]

        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Ä–∞—á–µ
        doctor_id = data.get("doctor_id")
        cur.execute("SELECT full_name FROM doctors WHERE id = ?", (doctor_id,))
        doctor_name = cur.fetchone()[0]

        # –ü–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º—è
        cur.execute("SELECT time FROM schedule WHERE id = ?", (schedule_id,))
        time_str = cur.fetchone()[0]

    # –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    text = (
        f"‚úÖ <b>–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!</b>\n\n"
        f"üêæ <b>–ü–∏—Ç–æ–º–µ—Ü:</b> {pet_name}\n"
        f"üë©‚Äç‚öïÔ∏è <b>–í—Ä–∞—á:</b> {doctor_name}\n"
        f"üßæ <b>–£—Å–ª—É–≥–∞:</b> {service_name}\n"
        f"üìÖ <b>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è:</b> {date_iso} –≤ {time_str}\n\n"
        f"<i>–ù–æ–º–µ—Ä –∑–∞–ø–∏—Å–∏: #{appointment_id}</i>"
    )
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üìã –ú–æ–∏ –∑–∞–ø–∏—Å–∏", callback_data="my_appointments")],
        [InlineKeyboardButton(text="üè† –í –º–µ–Ω—é", callback_data="back_to_menu")]
    ])
    try:
        await callback.message.edit_text(text, reply_markup=kb, parse_mode="HTML")
    except Exception:
        await callback.message.answer(text, reply_markup=kb, parse_mode="HTML")

    await state.clear()

============================================================
–§–ê–ô–õ: handlers\calendar.py
============================================================

from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, CallbackQuery
from aiogram.filters.callback_data import CallbackData
from datetime import datetime, timedelta, date
from typing import Optional, Tuple


class SimpleCalendarCallback(CallbackData, prefix="simple_cal"):
    action: str  # "select", "ignore"
    date_iso: str  # YYYY-MM-DD


class SimpleCalendar:

    @staticmethod
    async def start_calendar(available_dates: list, days_ahead: int = 7) -> InlineKeyboardMarkup:
        """
        –°–æ–∑–¥–∞–µ—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ days_ahead –¥–Ω–µ–π —Å —É—á–µ—Ç–æ–º –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∞—Ç
        """
        today = date.today()
        markup = []

        # –ó–∞–≥–æ–ª–æ–≤–æ–∫
        markup.append([
            InlineKeyboardButton(
                text="üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É",
                callback_data=SimpleCalendarCallback(
                    action="ignore",
                    date_iso="header"
                ).pack()
            )
        ])

        # –°–æ–∑–¥–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
        week_days_header = []
        current_header_date = today

        for i in range(days_ahead):
            day_index = current_header_date.weekday()
            day_names = ["–ü–Ω", "–í—Ç", "–°—Ä", "–ß—Ç", "–ü—Ç", "–°–±", "–í—Å"]
            week_days_header.append(day_names[day_index])
            current_header_date += timedelta(days=1)

        # –ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏
        markup.append([
            InlineKeyboardButton(
                text=day,
                callback_data=SimpleCalendarCallback(action="ignore", date_iso=f"wd_{i}").pack()
            ) for i, day in enumerate(week_days_header)
        ])

        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ —Å –¥–∞—Ç–∞–º–∏
        current_date = today
        date_buttons = []

        for i in range(days_ahead):
            day_number = current_date.day
            date_iso = current_date.isoformat()

            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
            if current_date == today:
                button_text = f"üìç{day_number}"
            elif current_date.weekday() >= 5:  # –°—É–±–±–æ—Ç–∞ –∏ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ
                button_text = f"üå¥{day_number}"
            else:
                button_text = f"{day_number}"

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –¥–∞—Ç—ã
            if date_iso in available_dates:
                date_buttons.append(
                    InlineKeyboardButton(
                        text=button_text,
                        callback_data=SimpleCalendarCallback(
                            action="select",
                            date_iso=date_iso
                        ).pack()
                    )
                )
            else:
                date_buttons.append(
                    InlineKeyboardButton(
                        text="¬∑",
                        callback_data=SimpleCalendarCallback(action="ignore", date_iso="unavailable").pack()
                    )
                )

            current_date += timedelta(days=1)

        # –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —Å—Ç—Ä–æ–∫–∏ (–º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–Ω–æ–ø–æ–∫ –≤ —Å—Ç—Ä–æ–∫–µ)
        buttons_per_row = 7  # –í—Å–µ –¥–Ω–∏ –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ
        for i in range(0, len(date_buttons), buttons_per_row):
            markup.append(date_buttons[i:i + buttons_per_row])

        # –ü–æ–¥–ø–∏—Å—å —Å –¥–∏–∞–ø–∞–∑–æ–Ω–æ–º –¥–∞—Ç
        end_date = today + timedelta(days=days_ahead - 1)
        date_range = f"{today.strftime('%d.%m')}-{end_date.strftime('%d.%m')}"
        markup.append([
            InlineKeyboardButton(
                text=f"üìÜ {date_range}",
                callback_data=SimpleCalendarCallback(action="ignore", date_iso="range").pack()
            )
        ])

        # –õ–µ–≥–µ–Ω–¥–∞
        markup.append([
            InlineKeyboardButton(text="üìç - —Å–µ–≥–æ–¥–Ω—è",
                                 callback_data=SimpleCalendarCallback(action="ignore", date_iso="legend_today").pack()),
            InlineKeyboardButton(text="üå¥ - –≤—ã—Ö–æ–¥–Ω–æ–π", callback_data=SimpleCalendarCallback(action="ignore",
                                                                                           date_iso="legend_weekend").pack())
        ])

        # –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        markup.append([
            InlineKeyboardButton(
                text="‚ùå –û—Ç–º–µ–Ω–∞",
                callback_data=SimpleCalendarCallback(action="ignore", date_iso="cancel").pack()
            )
        ])

        return InlineKeyboardMarkup(inline_keyboard=markup)

    @staticmethod
    async def process_selection(query: CallbackQuery, data: SimpleCalendarCallback) -> Tuple[bool, Optional[date]]:
        """
        –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä –¥–∞—Ç—ã
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: (success, selected_date)
        """
        if data.action == "ignore":
            if data.date_iso == "cancel":
                await query.message.edit_text("‚ùå –í—ã–±–æ—Ä –¥–∞—Ç—ã –æ—Ç–º–µ–Ω–µ–Ω")
                return True, None
            await query.answer()
            return False, None

        if data.action == "select":
            try:
                selected_date = datetime.strptime(data.date_iso, "%Y-%m-%d").date()
                await query.answer(f"‚úÖ –í—ã–±—Ä–∞–Ω–∞ –¥–∞—Ç–∞: {selected_date.strftime('%d.%m.%Y')}")
                return True, selected_date
            except ValueError:
                await query.answer("‚ùå –û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã")
                return False, None

        return False, None


# –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –≤–µ—Ä—Å–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è, –∫–æ—Ç–æ—Ä–∞—è –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–ª–Ω—ã–µ –Ω–µ–¥–µ–ª–∏
class WeekCalendar:

    @staticmethod
    async def start_calendar(available_dates: list, weeks_ahead: int = 1) -> InlineKeyboardMarkup:
        """
        –°–æ–∑–¥–∞–µ—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞ –ø–æ–ª–Ω—ã–µ –Ω–µ–¥–µ–ª–∏
        """
        today = date.today()
        markup = []

        # –ó–∞–≥–æ–ª–æ–≤–æ–∫
        markup.append([
            InlineKeyboardButton(
                text="üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É",
                callback_data=SimpleCalendarCallback(action="ignore", date_iso="header").pack()
            )
        ])

        # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏
        week_days = ["–ü–Ω", "–í—Ç", "–°—Ä", "–ß—Ç", "–ü—Ç", "–°–±", "–í—Å"]
        markup.append([
            InlineKeyboardButton(text=day,
                                 callback_data=SimpleCalendarCallback(action="ignore", date_iso=f"wd_{i}").pack())
            for i, day in enumerate(week_days)
        ])

        # –ù–∞—Ö–æ–¥–∏–º –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏
        days_since_monday = today.weekday()
        start_date = today - timedelta(days=days_since_monday)

        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–µ–¥–µ–ª–∏
        current_date = start_date
        total_days = weeks_ahead * 7

        for week in range(weeks_ahead):
            week_row = []
            for day in range(7):
                date_iso = current_date.isoformat()
                day_number = current_date.day

                # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
                if current_date == today:
                    button_text = f"üìç{day_number}"
                elif current_date.weekday() >= 5:
                    button_text = f"üå¥{day_number}"
                else:
                    button_text = f"{day_number}"

                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å (—Ç–æ–ª—å–∫–æ –±—É–¥—É—â–∏–µ –¥–∞—Ç—ã)
                is_available = date_iso in available_dates and current_date >= today

                if is_available:
                    week_row.append(
                        InlineKeyboardButton(
                            text=button_text,
                            callback_data=SimpleCalendarCallback(action="select", date_iso=date_iso).pack()
                        )
                    )
                else:
                    week_row.append(
                        InlineKeyboardButton(
                            text="¬∑",
                            callback_data=SimpleCalendarCallback(action="ignore", date_iso="unavailable").pack()
                        )
                    )

                current_date += timedelta(days=1)

            markup.append(week_row)

        # –ü–æ–¥–ø–∏—Å—å —Å –¥–∏–∞–ø–∞–∑–æ–Ω–æ–º –¥–∞—Ç
        end_date = start_date + timedelta(days=total_days - 1)
        date_range = f"{start_date.strftime('%d.%m')}-{end_date.strftime('%d.%m')}"
        markup.append([
            InlineKeyboardButton(
                text=f"üìÜ {date_range}",
                callback_data=SimpleCalendarCallback(action="ignore", date_iso="range").pack()
            )
        ])

        # –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        markup.append([
            InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞",
                                 callback_data=SimpleCalendarCallback(action="ignore", date_iso="cancel").pack())
        ])

        return InlineKeyboardMarkup(inline_keyboard=markup)

============================================================
–§–ê–ô–õ: handlers\common.py
============================================================

from aiogram import Router, F
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, CallbackQuery, Message
from aiogram.fsm.context import FSMContext

router = Router()

# –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —á–µ—Ä–µ–∑ inline-–∫–Ω–æ–ø–∫–∏
def main_menu_inline():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üêæ –ú–æ–∏ –ø–∏—Ç–æ–º—Ü—ã", callback_data="my_pets")],
        [InlineKeyboardButton(text="üìÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –∫ –≤—Ä–∞—á—É", callback_data="book_visit")],
        [InlineKeyboardButton(text="üßæ –ú–æ–∏ –∑–∞–ø–∏—Å–∏", callback_data="my_appointments")],
    ])


# === –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ / —Å—Ç–∞—Ä—Ç ===
@router.message(F.text.in_({"/start", "/menu"}))
async def start_message(message: Message, state: FSMContext):
    await state.clear()
    user_name = message.from_user.full_name or message.from_user.username or "–¥—Ä—É–≥"
    await message.answer(
        f"üêæ –ü—Ä–∏–≤–µ—Ç, {user_name}!\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–∏–∂–µ:",
        reply_markup=main_menu_inline()
    )


@router.callback_query(F.data == "back_to_menu")
async def back_to_menu(callback: CallbackQuery, state: FSMContext):
    data = await state.get_data()
    welcome_id = data.get("welcome_message_id")
    sent_messages = data.get("sent_messages", [])

    # –£–¥–∞–ª—è–µ–º –≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞, –∫—Ä–æ–º–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
    for msg_id in sent_messages:
        if msg_id != welcome_id:
            try:
                await callback.message.bot.delete_message(chat_id=callback.from_user.id, message_id=msg_id)
            except:
                pass  # –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ —É–¥–∞–ª–µ–Ω–æ –∏–ª–∏ –Ω–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º

    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
    await state.update_data(sent_messages=[welcome_id])

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
    try:
        sent_menu = await callback.message.edit_text("üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:", reply_markup=main_menu_inline())
    except:
        sent_menu = await callback.message.answer("üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:", reply_markup=main_menu_inline())

    # –î–æ–±–∞–≤–ª—è–µ–º ID –Ω–æ–≤–æ–≥–æ –º–µ–Ω—é –≤ —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
    data = await state.get_data()
    messages = data.get("sent_messages", [])
    messages.append(sent_menu.message_id)
    await state.update_data(sent_messages=messages)

    await callback.answer()

async def add_message_to_state(message, state):
    data = await state.get_data()
    messages = data.get("sent_messages", [])
    messages.append(message.message_id)
    await state.update_data(sent_messages=messages)

async def delete_previous_messages(message, state, keep_ids=[]):
    data = await state.get_data()
    messages = data.get("sent_messages", [])

    for msg_id in messages:
        if msg_id not in keep_ids:
            try:
                await message.bot.delete_message(chat_id=message.chat.id, message_id=msg_id)
            except Exception:
                pass  # —Å–æ–æ–±—â–µ–Ω–∏–µ –º–æ–≥–ª–æ –±—ã—Ç—å —É–∂–µ —É–¥–∞–ª–µ–Ω–æ

    remaining = [mid for mid in messages if mid in keep_ids]
    await state.update_data(sent_messages=remaining)


============================================================
–§–ê–ô–õ: handlers\notifications.py
============================================================

import asyncio
import logging
from datetime import datetime, timedelta
from aiogram import Router
from aiogram.types import Message
from db.db_utils import connect

router = Router()

# === –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –ø—Ä–∏—ë–º–æ–≤ ===
def get_upcoming_appointments():
    with connect() as conn:
        cur = conn.cursor()
        cur.execute("""
            SELECT 
                a.id,
                u.telegram_id,
                p.name AS pet_name,
                d.full_name AS doctor_name,
                s.name AS service_name,
                sch.date,
                sch.time,
                a.notified_24h,
                a.notified_2h
            FROM appointments a
            JOIN users u ON a.user_id = u.id
            JOIN pets p ON a.pet_id = p.id
            JOIN doctors d ON a.doctor_id = d.id
            JOIN services s ON a.service_id = s.id
            JOIN schedule sch ON a.schedule_id = sch.id
            WHERE a.status = 'scheduled'
        """)
        return cur.fetchall()

# === –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π ===
async def check_and_send_notifications(bot):
    now = datetime.now()
    upcoming = get_upcoming_appointments()

    for appt in upcoming:
        (
            appointment_id,
            telegram_id,
            pet_name,
            doctor_name,
            service_name,
            appt_date,
            appt_time,
            notified_24h,
            notified_2h
        ) = appt

        try:
            appt_datetime = datetime.strptime(f"{appt_date} {appt_time}", "%Y-%m-%d %H:%M")
        except Exception:
            continue

        time_until = appt_datetime - now

        # === –ó–∞ 24 —á–∞—Å–∞ ===
        if timedelta(hours=23, minutes=50) < time_until < timedelta(hours=24, minutes=10) and not notified_24h:
            await bot.send_message(
                telegram_id,
                f"üìÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ!\n"
                f"–ß–µ—Ä–µ–∑ —Å—É—Ç–∫–∏ —É –≤–∞—Å –ø—Ä–∏—ë–º:\n\n"
                f"üêæ –ü–∏—Ç–æ–º–µ—Ü: {pet_name}\n"
                f"üë©‚Äç‚öïÔ∏è –í—Ä–∞—á: {doctor_name}\n"
                f"üßæ –£—Å–ª—É–≥–∞: {service_name}\n"
                f"üïì –í—Ä–µ–º—è: {appt_time} ({appt_date})"
            )
            mark_notified(appointment_id, "24h")

        # === –ó–∞ 2 —á–∞—Å–∞ ===
        elif timedelta(hours=1, minutes=50) < time_until < timedelta(hours=2, minutes=10) and not notified_2h:
            await bot.send_message(
                telegram_id,
                f"‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ!\n"
                f"–ß–µ—Ä–µ–∑ 2 —á–∞—Å–∞ —É –≤–∞—Å –ø—Ä–∏—ë–º:\n\n"
                f"üêæ –ü–∏—Ç–æ–º–µ—Ü: {pet_name}\n"
                f"üë©‚Äç‚öïÔ∏è –í—Ä–∞—á: {doctor_name}\n"
                f"üßæ –£—Å–ª—É–≥–∞: {service_name}\n"
                f"üïì –í—Ä–µ–º—è: {appt_time} ({appt_date})"
            )
            mark_notified(appointment_id, "2h")

# === –ü–æ–º–µ—Ç–∫–∞ –æ–± –æ—Ç–ø—Ä–∞–≤–∫–µ ===
def mark_notified(appointment_id: int, kind: str):
    with connect() as conn:
        cur = conn.cursor()
        if kind == "24h":
            cur.execute("UPDATE appointments SET notified_24h = 1 WHERE id = ?", (appointment_id,))
        elif kind == "2h":
            cur.execute("UPDATE appointments SET notified_2h = 1 WHERE id = ?", (appointment_id,))
        conn.commit()

# === –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ ===
async def notifications_scheduler(bot):
    logging.info("üîî –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∑–∞–ø—É—â–µ–Ω–∞...")
    while True:
        await check_and_send_notifications(bot)
        await asyncio.sleep(300)  # –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç

# === –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–¥–ª—è —Ç–µ—Å—Ç–∞) ===
@router.message(lambda msg: msg.text == "/check_notifications")
async def manual_check(message: Message):
    await check_and_send_notifications(message.bot)
    await message.answer("üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤—ã–ø–æ–ª–Ω–µ–Ω–∞.")


============================================================
–§–ê–ô–õ: handlers\pets.py
============================================================

# handlers/pets.py
from aiogram import Router, F
from aiogram.types import Message, CallbackQuery, InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.context import FSMContext
from aiogram.filters import StateFilter

from db.db_utils import get_user_by_telegram_id, get_user_pets, add_pet, connect
from handlers.common import main_menu_inline

router = Router()


# === –°–æ—Å—Ç–æ—è–Ω–∏—è FSM –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–∏—Ç–æ–º—Ü–∞ ===
class PetState(StatesGroup):
    waiting_name = State()
    waiting_species = State()
    waiting_age = State()


# === –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø–∏—Ç–æ–º—Ü–µ–≤ ===
def pets_keyboard(pets):
    kb = []
    for pet in pets:
        pet_id, name, species, age = pet
        kb.append([InlineKeyboardButton(text=f"‚ùå –£–¥–∞–ª–∏—Ç—å {name}", callback_data=f"delete_pet_{pet_id}")])
    kb.append([InlineKeyboardButton(text="‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–∏—Ç–æ–º—Ü–∞", callback_data="add_pet")])
    kb.append([InlineKeyboardButton(text="üè† –í –º–µ–Ω—é", callback_data="back_to_menu")])
    return InlineKeyboardMarkup(inline_keyboard=kb)


# === –ü—Ä–æ—Å–º–æ—Ç—Ä –ø–∏—Ç–æ–º—Ü–µ–≤ ===
@router.callback_query(F.data == "my_pets")
async def show_my_pets(callback: CallbackQuery):
    user = get_user_by_telegram_id(callback.from_user.id)
    if not user:
        await callback.message.answer("‚ùó –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã. –í–≤–µ–¥–∏—Ç–µ /start.")
        await callback.answer()
        return

    pets = get_user_pets(user[0])
    if not pets:
        text = "üêæ –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø–∏—Ç–æ–º—Ü–µ–≤."
    else:
        text = "üêæ –í–∞—à–∏ –ø–∏—Ç–æ–º—Ü—ã:\n\n"
        for p in pets:
            text += f"‚Ä¢ {p[1]} ({p[2] or '–≤–∏–¥ –Ω–µ —É–∫–∞–∑–∞–Ω'}, {p[3] or '–≤–æ–∑—Ä–∞—Å—Ç –Ω–µ —É–∫–∞–∑–∞–Ω'})\n"

    kb = pets_keyboard(pets)
    try:
        await callback.message.edit_text(text, reply_markup=kb)
    except Exception:
        await callback.message.answer(text, reply_markup=kb)
    await callback.answer()


# === –£–¥–∞–ª–µ–Ω–∏–µ –ø–∏—Ç–æ–º—Ü–∞ ===
@router.callback_query(F.data.startswith("delete_pet_"))
async def delete_pet(callback: CallbackQuery):
    pet_id = int(callback.data.split("_")[-1])
    user = get_user_by_telegram_id(callback.from_user.id)
    if not user:
        await callback.answer("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return

    with connect() as conn:
        cur = conn.cursor()
        cur.execute("DELETE FROM pets WHERE id=? AND user_id=?", (pet_id, user[0]))
        conn.commit()

    pets = get_user_pets(user[0])
    if not pets:
        text = "üêæ –£ –≤–∞—Å –±–æ–ª—å—à–µ –Ω–µ—Ç –ø–∏—Ç–æ–º—Ü–µ–≤."
    else:
        text = "üêæ –í–∞—à–∏ –ø–∏—Ç–æ–º—Ü—ã:\n\n"
        for p in pets:
            text += f"‚Ä¢ {p[1]} ({p[2] or '–≤–∏–¥ –Ω–µ —É–∫–∞–∑–∞–Ω'}, {p[3] or '–≤–æ–∑—Ä–∞—Å—Ç –Ω–µ —É–∫–∞–∑–∞–Ω'})\n"

    kb = pets_keyboard(pets)
    try:
        await callback.message.edit_text(text, reply_markup=kb)
    except Exception:
        await callback.message.answer(text, reply_markup=kb)
    await callback.answer("‚úÖ –ü–∏—Ç–æ–º–µ—Ü —É–¥–∞–ª—ë–Ω.")


# === –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–∏—Ç–æ–º—Ü–∞ ===
@router.callback_query(F.data == "add_pet")
async def add_pet_start(callback: CallbackQuery, state: FSMContext):
    await state.set_state(PetState.waiting_name)

    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üè† –û—Ç–º–µ–Ω–∞", callback_data="cancel_pet_add")]
    ])

    await callback.message.edit_text("üê∂ –ö–∞–∫ –∑–æ–≤—É—Ç –≤–∞—à–µ–≥–æ –ø–∏—Ç–æ–º—Ü–∞?\n\n(–≤–≤–µ–¥–∏—Ç–µ –∏–º—è –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏)", reply_markup=kb)
    await callback.answer()


@router.message(StateFilter(PetState.waiting_name))
async def pet_name_entered(message: Message, state: FSMContext):
    name = message.text.strip()
    if not name:
        await message.answer("‚ö†Ô∏è –ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–∏—Ç–æ–º—Ü–∞.")
        return

    await state.update_data(pet_name=name)
    await state.set_state(PetState.waiting_species)

    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üê± –ö–æ—à–∫–∞", callback_data="species_–ö–æ—à–∫–∞"),
         InlineKeyboardButton(text="üê∂ –°–æ–±–∞–∫–∞", callback_data="species_–°–æ–±–∞–∫–∞")],
        [InlineKeyboardButton(text="üêπ –ì—Ä—ã–∑—É–Ω", callback_data="species_–ì—Ä—ã–∑—É–Ω"),
         InlineKeyboardButton(text="ü¶ú –ü—Ç–∏—Ü–∞", callback_data="species_–ü—Ç–∏—Ü–∞")],
        [InlineKeyboardButton(text="ü¶é –†–µ–ø—Ç–∏–ª–∏—è", callback_data="species_–†–µ–ø—Ç–∏–ª–∏—è"),
         InlineKeyboardButton(text="üê† –†—ã–±–∞", callback_data="species_–†—ã–±–∞")],
        [InlineKeyboardButton(text="üêá –ö—Ä–æ–ª–∏–∫", callback_data="species_–ö—Ä–æ–ª–∏–∫"),
         InlineKeyboardButton(text="üê¢ –ß–µ—Ä–µ–ø–∞—Ö–∞", callback_data="species_–ß–µ—Ä–µ–ø–∞—Ö–∞")],
        [InlineKeyboardButton(text="‚ùì –î—Ä—É–≥–æ–µ", callback_data="species_–î—Ä—É–≥–æ–µ")],
        [InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_name"),
         InlineKeyboardButton(text="üè† –û—Ç–º–µ–Ω–∞", callback_data="cancel_pet_add")]
    ])

    await message.answer("üêæ –í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥ –ø–∏—Ç–æ–º—Ü–∞:", reply_markup=kb)


# === –í—ã–±–æ—Ä –≤–∏–¥–∞ ===
@router.callback_query(StateFilter(PetState.waiting_species), F.data.startswith("species_"))
async def pet_species_selected(callback: CallbackQuery, state: FSMContext):
    species = callback.data.split("_", 1)[1]
    await state.update_data(pet_species=species)
    await state.set_state(PetState.waiting_age)

    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üçº –î–æ 1 –≥–æ–¥–∞", callback_data="age_–î–æ 1 –≥–æ–¥–∞")],
        [InlineKeyboardButton(text="üêï –û—Ç 1 –¥–æ 5 –ª–µ—Ç", callback_data="age_–û—Ç 1 –¥–æ 5 –ª–µ—Ç")],
        [InlineKeyboardButton(text="üêæ –û—Ç 5 –¥–æ 10 –ª–µ—Ç", callback_data="age_–û—Ç 5 –¥–æ 10 –ª–µ—Ç")],
        [InlineKeyboardButton(text="ü¶¥ –ë–æ–ª–µ–µ 10 –ª–µ—Ç", callback_data="age_–ë–æ–ª–µ–µ 10 –ª–µ—Ç")],
        [InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_species"),
         InlineKeyboardButton(text="üè† –û—Ç–º–µ–Ω–∞", callback_data="cancel_pet_add")]
    ])

    await callback.message.edit_text(f"–í—ã–±—Ä–∞–Ω –≤–∏–¥: {species}\nüïê –£–∫–∞–∂–∏—Ç–µ –≤–æ–∑—Ä–∞—Å—Ç –ø–∏—Ç–æ–º—Ü–∞:", reply_markup=kb)
    await callback.answer()


# === –í—ã–±–æ—Ä –≤–æ–∑—Ä–∞—Å—Ç–∞ ===
@router.callback_query(StateFilter(PetState.waiting_age), F.data.startswith("age_"))
async def pet_age_selected(callback: CallbackQuery, state: FSMContext):
    age = callback.data.split("_", 1)[1]

    data = await state.get_data()
    pet_name = data.get("pet_name")
    pet_species = data.get("pet_species")

    user = get_user_by_telegram_id(callback.from_user.id)
    if not user:
        await callback.message.answer("‚ùó –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –í–≤–µ–¥–∏—Ç–µ /start.")
        await state.clear()
        return

    add_pet(user_id=user[0], name=pet_name, species=pet_species, age=age)
    await state.clear()

    pets = get_user_pets(user[0])
    text = "üêæ –í–∞—à–∏ –ø–∏—Ç–æ–º—Ü—ã:\n\n"
    for p in pets:
        text += f"‚Ä¢ {p[1]} ({p[2] or '–≤–∏–¥ –Ω–µ —É–∫–∞–∑–∞–Ω'}, {p[3] or '–≤–æ–∑—Ä–∞—Å—Ç –Ω–µ —É–∫–∞–∑–∞–Ω'})\n"

    kb = pets_keyboard(pets)
    await callback.message.edit_text(f"‚úÖ –ü–∏—Ç–æ–º–µ—Ü {pet_name} ({pet_species}, {age}) –¥–æ–±–∞–≤–ª–µ–Ω!", reply_markup=kb)
    await callback.answer()


# === –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –∏ "–û—Ç–º–µ–Ω–∞" ===
@router.callback_query(F.data == "back_to_name")
async def back_to_name(callback: CallbackQuery, state: FSMContext):
    await state.set_state(PetState.waiting_name)
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üè† –û—Ç–º–µ–Ω–∞", callback_data="cancel_pet_add")]
    ])
    await callback.message.edit_text("üê∂ –ö–∞–∫ –∑–æ–≤—É—Ç –≤–∞—à–µ–≥–æ –ø–∏—Ç–æ–º—Ü–∞? (–≤–≤–µ–¥–∏—Ç–µ –∏–º—è)", reply_markup=kb)
    await callback.answer()


@router.callback_query(F.data == "back_to_species")
async def back_to_species(callback: CallbackQuery, state: FSMContext):
    await state.set_state(PetState.waiting_species)
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üê± –ö–æ—à–∫–∞", callback_data="species_–ö–æ—à–∫–∞"),
         InlineKeyboardButton(text="üê∂ –°–æ–±–∞–∫–∞", callback_data="species_–°–æ–±–∞–∫–∞")],
        [InlineKeyboardButton(text="üêπ –ì—Ä—ã–∑—É–Ω", callback_data="species_–ì—Ä—ã–∑—É–Ω"),
         InlineKeyboardButton(text="ü¶ú –ü—Ç–∏—Ü–∞", callback_data="species_–ü—Ç–∏—Ü–∞")],
        [InlineKeyboardButton(text="ü¶é –†–µ–ø—Ç–∏–ª–∏—è", callback_data="species_–†–µ–ø—Ç–∏–ª–∏—è"),
         InlineKeyboardButton(text="üê† –†—ã–±–∞", callback_data="species_–†—ã–±–∞")],
        [InlineKeyboardButton(text="üêá –ö—Ä–æ–ª–∏–∫", callback_data="species_–ö—Ä–æ–ª–∏–∫"),
         InlineKeyboardButton(text="üê¢ –ß–µ—Ä–µ–ø–∞—Ö–∞", callback_data="species_–ß–µ—Ä–µ–ø–∞—Ö–∞")],
        [InlineKeyboardButton(text="‚ùì –î—Ä—É–≥–æ–µ", callback_data="species_–î—Ä—É–≥–æ–µ")],
        [InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_name"),
         InlineKeyboardButton(text="üè† –û—Ç–º–µ–Ω–∞", callback_data="cancel_pet_add")]
    ])
    await callback.message.edit_text("üêæ –í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥ –ø–∏—Ç–æ–º—Ü–∞:", reply_markup=kb)
    await callback.answer()


@router.callback_query(F.data == "cancel_pet_add")
async def cancel_pet_add(callback: CallbackQuery, state: FSMContext):
    await state.clear()
    await callback.message.edit_text("‚ùå –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–∏—Ç–æ–º—Ü–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ.", reply_markup=main_menu_inline)
    await callback.answer("–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")


============================================================
–§–ê–ô–õ: handlers\registration.py
============================================================

# handlers/registration.py
from aiogram import Router, F, types
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.context import FSMContext

from aiogram.types import ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardMarkup, InlineKeyboardButton
from db.db_utils import get_user_by_telegram_id, add_user, add_pet
from handlers.common import main_menu_inline

router = Router()


# === –°–æ—Å—Ç–æ—è–Ω–∏—è FSM ===
class RegistrationState(StatesGroup):
    waiting_phone = State()
    waiting_pet_name = State()
    waiting_pet_species = State()
    waiting_pet_age = State()

WELCOME_TEXT = (
    "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ *–£—Å—ã, –ª–∞–ø—ã –∏ —Ö–≤–æ—Å—Ç*! üêæ\n\n"
    "–ú—ã –∑–∞–±–æ—Ç–∏–º—Å—è –æ –∑–¥–æ—Ä–æ–≤—å–µ –≤–∞—à–∏—Ö –ø–∏—Ç–æ–º—Ü–µ–≤ –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø–æ–ª–Ω—ã–π —Å–ø–µ–∫—Ç—Ä –≤–µ—Ç–µ—Ä–∏–Ω–∞—Ä–Ω—ã—Ö —É—Å–ª—É–≥:\n\n"
    "ü©∫ –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –∏ –ø—Ä–∏—ë–º—ã –æ–ø—ã—Ç–Ω—ã—Ö –≤—Ä–∞—á–µ–π - –æ—Ç 1200 —Ä—É–±–ª–µ–π\n"
    "üê∂ –õ–µ—á–µ–Ω–∏–µ –∏ —É—Ö–æ–¥ –∑–∞ —Å–æ–±–∞–∫–∞–º–∏, –∫–æ—à–∫–∞–º–∏ –∏ –¥—Ä—É–≥–∏–º–∏ –ø–∏—Ç–æ–º—Ü–∞–º–∏ - –æ—Ç 300 —Ä—É–±–ª–µ–π\n"
    "üíâ –í–∞–∫—Ü–∏–Ω–∞—Ü–∏—è, —á–∏–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π - –æ—Ç 800 —Ä—É–±–ª–µ–π\n"
    "üßæ –£–¥–æ–±–Ω–∞—è –∑–∞–ø–∏—Å—å –Ω–∞ –ø—Ä–∏—ë–º –ø—Ä—è–º–æ —á–µ—Ä–µ–∑ Telegram-–±–æ—Ç–∞\n\n"
    "üåü –ù–∞—à–∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:\n"
    "‚Ä¢ –î—Ä—É–∂–µ–ª—é–±–Ω–∞—è –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞ –∏ –∑–∞–±–æ—Ç–ª–∏–≤—ã–π –ø–µ—Ä—Å–æ–Ω–∞–ª\n"
    "‚Ä¢ –°–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥–∏–∫–∏\n"
    "‚Ä¢ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –ø—Ä–∏—ë–º–µ –∏ —É–¥–æ–±–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –≤–∞—à–∏–º –ø–∏—Ç–æ–º—Ü–∞–º\n\n"
)

@router.message(F.text == "/start")
async def start_command(message: types.Message, state: FSMContext):
    user = get_user_by_telegram_id(message.from_user.id)

    # --- –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∫–ª–∞–º–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ---
    sent_welcome = await message.answer(WELCOME_TEXT)

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ state
    await state.update_data(
        welcome_message_id=sent_welcome.message_id,
        sent_messages=[sent_welcome.message_id]  # —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –±–æ—Ç–∞
    )

    if user:
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
        sent_menu = await message.answer(
            f"üëã –° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, {user[3] or message.from_user.full_name}! "
            "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–∏–∂–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º üè•",
            reply_markup=main_menu_inline()
        )
        # –î–æ–±–∞–≤–ª—è–µ–º –º–µ–Ω—é –≤ —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
        data = await state.get_data()
        messages = data.get("sent_messages", [])
        messages.append(sent_menu.message_id)
        await state.update_data(sent_messages=messages)
        return

    # --- –ù–æ–≤–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ‚Äî –∑–∞–ø—Ä–æ—Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞ ---
    contact_btn = KeyboardButton(text="üì± –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞", request_contact=True)
    kb = ReplyKeyboardMarkup(resize_keyboard=True, keyboard=[[contact_btn]])
    sent_phone_request = await message.answer(
        "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–µ–ª–∏—Ç–µ—Å—å –≤–∞—à–∏–º –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞, —á—Ç–æ–±—ã –º—ã –º–æ–≥–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –≤–∞—Å:",
        reply_markup=kb
    )
    # –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
    data = await state.get_data()
    messages = data.get("sent_messages", [])
    messages.append(sent_phone_request.message_id)
    await state.update_data(sent_messages=messages)

    await state.set_state(RegistrationState.waiting_phone)

# === –ü–æ–ª—É—á–∞–µ–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ ===
@router.message(RegistrationState.waiting_phone, F.contact)
async def process_phone(message: types.Message, state: FSMContext):
    phone = message.contact.phone_number
    full_name = message.from_user.full_name

    add_user(telegram_id=message.from_user.id, phone=phone, full_name=full_name)

    await state.update_data(phone=phone, full_name=full_name)
    await state.set_state(RegistrationState.waiting_pet_name)

    await message.answer("üêæ –¢–µ–ø–µ—Ä—å –¥–æ–±–∞–≤–∏–º –≤–∞—à–µ–≥–æ –ø–∏—Ç–æ–º—Ü–∞!\n–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–∏—Ç–æ–º—Ü–∞:", reply_markup=types.ReplyKeyboardRemove())


# === –ò–º—è –ø–∏—Ç–æ–º—Ü–∞ ===
@router.message(RegistrationState.waiting_pet_name)
async def pet_name(message: types.Message, state: FSMContext):
    name = message.text.strip()
    if not name:
        await message.answer("‚ö†Ô∏è –ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–∏—Ç–æ–º—Ü–∞.")
        return

    await state.update_data(pet_name=name)
    await state.set_state(RegistrationState.waiting_pet_species)
    await message.answer("üê∂ –£–∫–∞–∂–∏—Ç–µ –≤–∏–¥ –ø–∏—Ç–æ–º—Ü–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –∫–æ—à–∫–∞, —Å–æ–±–∞–∫–∞):")


# === –í–∏–¥ –ø–∏—Ç–æ–º—Ü–∞ ===
@router.message(RegistrationState.waiting_pet_species)
async def pet_species(message: types.Message, state: FSMContext):
    species = message.text.strip()
    if not species:
        await message.answer("‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –≤–∏–¥ –ø–∏—Ç–æ–º—Ü–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –∫–æ—à–∫–∞, —Å–æ–±–∞–∫–∞).")
        return

    await state.update_data(pet_species=species)
    await state.set_state(RegistrationState.waiting_pet_age)
    await message.answer("üïê –£–∫–∞–∂–∏—Ç–µ –≤–æ–∑—Ä–∞—Å—Ç –ø–∏—Ç–æ–º—Ü–∞ (–≤ –≥–æ–¥–∞—Ö, –º–æ–∂–Ω–æ –¥—Ä–æ–±–Ω–æ):")


# === –í–æ–∑—Ä–∞—Å—Ç –ø–∏—Ç–æ–º—Ü–∞ ===
@router.message(RegistrationState.waiting_pet_age)
async def pet_age(message: types.Message, state: FSMContext):
    age_text = message.text.strip()
    age = None
    if age_text:
        try:
            _ = float(age_text.replace(",", "."))
            age = age_text
        except Exception:
            await message.answer("‚ö†Ô∏è –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤–æ–∑—Ä–∞—Å—Ç–∞. –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 3 –∏–ª–∏ 2.5) –∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º.")
            return

    data = await state.get_data()
    user = get_user_by_telegram_id(message.from_user.id)
    if not user:
        await message.answer("‚ùó –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞ /start.")
        await state.clear()
        return

    add_pet(
        user_id=user[0],
        name=data.get("pet_name"),
        species=data.get("pet_species"),
        age=age
    )

    await state.clear()

    await message.answer(
        f"‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n–ü–∏—Ç–æ–º–µ—Ü {data.get('pet_name')} ({data.get('pet_species')}) —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!",
        reply_markup=main_menu_inline()
    )



============================================================
–§–ê–ô–õ: handlers\__init__.py
============================================================



============================================================
–§–ê–ô–õ: services\scheduler.py
============================================================

from apscheduler.schedulers.asyncio import AsyncIOScheduler
from datetime import datetime
import asyncio

async def send_reminders(bot):
    now = datetime.now().strftime("%H:%M:%S")
    await bot.send_message(
        chat_id=123456789,  # üî∏ –≤—Ä–µ–º–µ–Ω–Ω–æ –º–æ–∂–Ω–æ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å —Å–≤–æ–π Telegram ID
        text=f"üîî –¢–µ—Å—Ç–æ–≤–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ ‚Äî {now}"
    )

def setup_scheduler(bot):
    scheduler = AsyncIOScheduler()
    scheduler.add_job(send_reminders, "interval", minutes=30, args=(bot,))
    scheduler.start()


============================================================
–§–ê–ô–õ: services\utils.py
============================================================

def format_datetime(date: str, time: str):
    return f"{date} –≤ {time}"
# –û–±—â–∏–µ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏


============================================================
–§–ê–ô–õ: services\__init__.py
============================================================


